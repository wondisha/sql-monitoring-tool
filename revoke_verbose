# Function to parse connection string into server and database
function Parse-ConnectionString {
    param(
        [string]$ConnectionString
    )
    $connBuilder = New-Object System.Data.SqlClient.SqlConnectionStringBuilder($ConnectionString)
    [PSCustomObject]@{
        SqlInstance = $connBuilder.DataSource
        Database = $connBuilder.InitialCatalog
    }
}

Set-DbatoolsInsecureConnection -SessionOnly

$centralConnStr = "Server=CentralServer;Database=CentralDB;Integrated Security=True"
$centralConnInfo = Parse-ConnectionString -ConnectionString $centralConnStr

$query = @"
SELECT Username, InstanceName, DatabaseName
FROM TempAccessRequests
WHERE ExpiresAt <= GETDATE() AND AccessRevoked = 0
"@

# **Logging: Show the initial query results**
Write-Host "Running initial query to find expired requests..."
$expired = Invoke-DbaQuery -SqlInstance $centralConnInfo.SqlInstance -Database $centralConnInfo.Database -Query $query
Write-Host "Found $($expired.Count) expired requests."

foreach ($row in $expired) {
    # **Logging: Show what the loop is doing**
    Write-Host "`nProcessing user $($row.Username) on $($row.InstanceName)\$($row.DatabaseName)..."
    
    $targetConnStr = "Server=$($row.InstanceName);Database=$($row.DatabaseName);Integrated Security=True"
    $targetConnInfo = Parse-ConnectionString -ConnectionString $targetConnStr

    $removeSql = @"
DECLARE @sql NVARCHAR(MAX) = N'';
SELECT @sql = @sql + 'EXEC sp_droprolemember N''' + r.name + ''', N''' + u.name + ''';'
FROM sys.database_principals u
JOIN sys.database_role_members rm ON u.principal_id = rm.member_principal_id
JOIN sys.database_principals r ON rm.role_principal_id = r.principal_id
WHERE u.name = N'$($row.Username)';
IF LEN(@sql) > 0 EXEC sp_executesql @sql;
"@
    try {
        # **Logging: Confirm the actions**
        Write-Host "  - Revoking role memberships..."
        Invoke-DbaQuery -SqlInstance $targetConnInfo.SqlInstance -Database $targetConnInfo.Database -Query $removeSql
        
        $dropUserSql = "IF EXISTS (SELECT 1 FROM sys.database_principals WHERE name = N'$($row.Username)') DROP USER [$($row.Username)];"
        Write-Host "  - Dropping user..."
        Invoke-DbaQuery -SqlInstance $targetConnInfo.SqlInstance -Database $targetConnInfo.Database -Query $dropUserSql

        $updateSql = "UPDATE TempAccessRequests SET AccessRevoked = 1 WHERE Username = '$($row.Username)' AND InstanceName = '$($row.InstanceName)' AND DatabaseName = '$($row.DatabaseName)' AND AccessRevoked = 0"
        Write-Host "  - Updating central table..."
        Invoke-DbaQuery -SqlInstance $centralConnInfo.SqlInstance -Database $centralConnInfo.Database -Query $updateSql
        
        Write-Host "  - SUCCESS: Access for $($row.Username) fully revoked."

    } catch {
        Write-Host "  - FAILED to process $($row.Username): $($_.Exception.Message)"
    }
}
Write-Host "Script execution completed."
